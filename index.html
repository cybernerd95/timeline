<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Timeline</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .auth-section {
      padding: 40px;
      text-align: center;
    }

    .auth-form {
      max-width: 400px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }

    input[type="email"],
    input[type="password"],
    input[type="datetime-local"],
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: transform 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    }

    .error {
      color: #e74c3c;
      margin-top: 10px;
      padding: 10px;
      background: #ffeaea;
      border-radius: 5px;
    }

    .timeline-section {
      padding: 40px;
      display: none;
    }

    .timeline-controls {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 40px;
    }

    .timeline-controls h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .timeline-container {
      position: relative;
      padding: 150px 50px;
      overflow-x: auto;
      min-height: 500px;
      background: #fafbfc;
      border-radius: 15px;
    }

    .timeline-line {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(to right, #667eea, #764ba2);
      border-radius: 2px;
      transform: translateY(-50%);
      z-index: 1;
    }

    .timeline-events {
      position: relative;
      height: 200px;
      z-index: 2;
      min-width: 100%;
    }

    .timeline-event {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 3;
    }

    .event-marker {
      position: absolute;
      width: 16px;
      height: 16px;
      background: #667eea;
      border: 3px solid white;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 4;
      cursor: pointer;
      transition: all 0.3s;
    }

    .event-marker:hover {
      transform: translate(-50%, -50%) scale(1.2);
      box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
    }

    .event-marker.today {
      background: #ff6b6b;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 10px rgba(255, 107, 107, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.8); }
      100% { box-shadow: 0 0 10px rgba(255, 107, 107, 0.5); }
    }

    .event-connector {
      position: absolute;
      left: 50%;
      width: 3px;
      background: #667eea;
      transform: translateX(-50%);
      z-index: 2;
    }

    .event-connector.above {
      bottom: 50%;
    }

    .event-connector.below {
      top: 50%;
    }

    .event-connector::after {
      content: '';
      position: absolute;
      width: 0;
      height: 0;
      left: 50%;
      transform: translateX(-50%);
      z-index: 3;
    }

    .event-connector.above::after {
      top: -8px;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid #667eea;
    }

    .event-connector.below::after {
      bottom: -8px;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid #667eea;
    }

    .event-box {
      position: absolute;
      min-width: 180px;
      max-width: 220px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      border: 2px solid #667eea;
      left: 50%;
      transform: translateX(-50%);
      cursor: pointer;
      transition: all 0.3s;
    }

    .event-box:hover {
      transform: translateX(-50%) translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .event-box.above {
      bottom: 0;
    }

    .event-box.below {
      top: 0;
    }

    .event-box.today {
      border-color: #ff6b6b;
      background: linear-gradient(135deg, #fff5f5 0%, #ffe0e0 100%);
    }

    .event-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 1em;
    }

    .event-date {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 8px;
    }

    .event-time-left {
      font-size: 0.75em;
      color: #999;
      margin-bottom: 12px;
      font-style: italic;
    }

    .event-actions {
      display: flex;
      gap: 5px;
      justify-content: center;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 11px;
      border-radius: 4px;
    }

    .today-marker {
      position: absolute;
      top: 30%;
      width: 3px;
      height: 40%;
      background: #ff6b6b;
      z-index: 5;
      box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
      transform: translateX(-50%);
    }

    .today-marker::before {
      content: 'TODAY';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #ff6b6b;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.7em;
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
      margin-bottom: 5px;
    }

    .today-marker::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-top: 5px solid #ff6b6b;
    }

    .timeline-years {
      position: absolute;
      bottom: 20px;
      left: 50px;
      right: 50px;
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: #666;
      font-weight: 500;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
    }

    .close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .close:hover {
      color: #333;
    }

    .empty-timeline {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #666;
    }

    .empty-timeline i {
      font-size: 4em;
      margin-bottom: 20px;
      color: #ccc;
    }

    .logout-container {
      text-align: right;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .timeline-container {
        padding: 100px 20px;
      }
      
      .event-box {
        min-width: 150px;
        max-width: 180px;
        font-size: 0.9em;
      }
      
      .timeline-line {
        left: 20px;
        right: 20px;
      }
      
      .timeline-years {
        left: 20px;
        right: 20px;
        font-size: 0.8em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìÖ Interactive Timeline</h1>
      <p>Create and manage your events timeline</p>
    </div>

    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
      <div class="auth-form">
        <h2>Login to Your Timeline</h2>
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" placeholder="Enter your email">
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" placeholder="Enter your password">
        </div>
        <button id="loginBtn" class="btn">Login</button>
        <button id="registerBtn" class="btn btn-secondary">Register</button>
        <div id="authError" class="error" style="display: none;"></div>
      </div>
    </div>

    <!-- Timeline Section -->
    <div id="timelineSection" class="timeline-section">
      <div class="logout-container">
        <span id="userEmail" style="margin-right: 15px; color: #666; font-weight: 500;"></span>
        <button id="logoutBtn" class="btn btn-danger">Logout</button>
      </div>

      <div class="timeline-controls">
        <h3>Add New Event</h3>
        <form id="eventForm">
          <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="title">Event Title:</label>
              <input type="text" id="title" placeholder="Enter event title" required>
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="time">Date & Time:</label>
              <input type="datetime-local" id="time" required>
            </div>
            <button type="submit" class="btn">Add Event</button>
          </div>
        </form>
      </div>

      <div class="timeline-container">
        <div class="timeline-line"></div>
        <div id="timeline" class="timeline-events">
          <div class="empty-timeline">
            <div style="font-size: 4em; margin-bottom: 20px;">‚è∞</div>
            <h3>No events yet</h3>
            <p>Add your first event to get started!</p>
          </div>
        </div>
        <div class="timeline-years" id="timelineYears"></div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Edit Event</h3>
      <form id="editForm">
        <div class="form-group">
          <label for="editTitle">Event Title:</label>
          <input type="text" id="editTitle" required>
        </div>
        <div class="form-group">
          <label for="editTime">Date & Time:</label>
          <input type="datetime-local" id="editTime" required>
        </div>
        <div style="text-align: center; margin-top: 20px;">
          <button type="submit" class="btn">Save Changes</button>
          <button type="button" id="cancelEdit" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    // Firebase configuration - ADD YOUR CREDENTIALS HERE
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Replace with your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAkWss4GTWopwjrqAEe71PUhiWHdGKTMlw",
      authDomain: "tasktimeline-4dffe.firebaseapp.com",
      projectId: "tasktimeline-4dffe",
      storageBucket: "tasktimeline-4dffe.firebasestorage.app",
      messagingSenderId: "329516169618",
      appId: "1:329516169618:web:e1fdd96fccab750f68294b"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentEditId = null;

    // DOM elements
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authError = document.getElementById("authError");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const authSection = document.getElementById("authSection");
    const timelineSection = document.getElementById("timelineSection");
    const eventForm = document.getElementById("eventForm");
    const timeInput = document.getElementById("time");
    const titleInput = document.getElementById("title");
    const timelineDiv = document.getElementById("timeline");
    const editModal = document.getElementById("editModal");
    const editForm = document.getElementById("editForm");
    const editTitle = document.getElementById("editTitle");
    const editTime = document.getElementById("editTime");

    // Register
    registerBtn.addEventListener("click", () => {
      console.log("Attempting to register:", emailInput.value);
      createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
        .then(userCredential => {
          console.log("Registration successful:", userCredential.user.email);
          authError.style.display = 'none';
        })
        .catch(err => {
          console.error("Registration error:", err);
          authError.textContent = err.message;
          authError.style.display = 'block';
        });
    });

    // Login
    loginBtn.addEventListener("click", () => {
      console.log("Attempting to login:", emailInput.value);
      signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
        .then(userCredential => {
          console.log("Login successful:", userCredential.user.email);
          authError.style.display = 'none';
        })
        .catch(err => {
          console.error("Login error:", err);
          authError.textContent = err.message;
          authError.style.display = 'block';
        });
    });

    // Logout
    logoutBtn.addEventListener("click", () => signOut(auth));

    // Auth State
    onAuthStateChanged(auth, user => {
      if(user){
        authSection.style.display = "none";
        timelineSection.style.display = "block";
        document.getElementById("userEmail").textContent = `Welcome, ${user.email}`;
        loadEvents();
      } else {
        authSection.style.display = "block";
        timelineSection.style.display = "none";
        timelineDiv.innerHTML = "";
      }
    });

    // Add Event
    eventForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      console.log("Attempting to add event...");
      console.log("User:", auth.currentUser?.email);
      console.log("Title:", titleInput.value);
      console.log("Time:", timeInput.value);
      
      try {
        const docRef = await addDoc(collection(db, "events"), {
          time: timeInput.value,
          title: titleInput.value,
          user: auth.currentUser.email,
          timestamp: new Date(timeInput.value).getTime(),
          createdAt: new Date()
        });
        console.log("Event added with ID: ", docRef.id);
        eventForm.reset();
      } catch (err) {
        console.error("Error adding event:", err);
        alert("Error adding event: " + err.message);
      }
    });

    // Edit Event
    editForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (currentEditId) {
        try {
          await updateDoc(doc(db, "events", currentEditId), {
            title: editTitle.value,
            time: editTime.value,
            timestamp: new Date(editTime.value).getTime()
          });
          editModal.style.display = "none";
          currentEditId = null;
        } catch (err) {
          console.error("Error updating event:", err);
        }
      }
    });

    // Delete Event
    async function deleteEvent(id) {
      if (confirm("Are you sure you want to delete this event?")) {
        try {
          await deleteDoc(doc(db, "events", id));
        } catch (err) {
          console.error("Error deleting event:", err);
        }
      }
    }

    // Open Edit Modal
    function openEditModal(id, title, time) {
      currentEditId = id;
      editTitle.value = title;
      editTime.value = time;
      editModal.style.display = "block";
    }

    // Close Modal
    document.querySelector(".close").addEventListener("click", () => {
      editModal.style.display = "none";
    });

    document.getElementById("cancelEdit").addEventListener("click", () => {
      editModal.style.display = "none";
    });

    window.addEventListener("click", (e) => {
      if (e.target === editModal) {
        editModal.style.display = "none";
      }
    });

    // Calculate time range for timeline positioning
    function calculateTimeRange(events) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      if (events.length === 0) {
        const startTime = today.getTime() - (30 * 24 * 60 * 60 * 1000); // 30 days before today
        const endTime = today.getTime() + (30 * 24 * 60 * 60 * 1000);   // 30 days after today
        return { startTime, endTime };
      }
      
      const eventTimes = events.map(e => e.timestamp);
      const minEventTime = Math.min(...eventTimes);
      const maxEventTime = Math.max(...eventTimes);
      
      // Include today in the range
      const minTime = Math.min(minEventTime, today.getTime());
      const maxTime = Math.max(maxEventTime, today.getTime());
      
      // Add padding to the range (at least 7 days on each side)
      const range = maxTime - minTime;
      const padding = Math.max(range * 0.2, 7 * 24 * 60 * 60 * 1000); // 20% padding or 7 days minimum
      
      return {
        startTime: minTime - padding,
        endTime: maxTime + padding
      };
    }

    // Get position based on time
    function getTimeBasedPosition(timestamp, timeRange, containerWidth) {
      const margin = 100;
      const availableWidth = containerWidth - (2 * margin);
      
      const timeSpan = timeRange.endTime - timeRange.startTime;
      
      // Prevent division by zero
      if (timeSpan === 0) {
        return containerWidth / 2; // Center position if all events are at the same time
      }
      
      const relativePosition = (timestamp - timeRange.startTime) / timeSpan;
      const position = margin + (relativePosition * availableWidth);
      
      // Ensure position is within bounds
      return Math.max(margin, Math.min(containerWidth - margin, position));
    }

    // Calculate time until/since event
    function getTimeUntilEvent(eventDate) {
      const now = new Date();
      const event = new Date(eventDate);
      const diffMs = event - now;
      const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays > 0) {
        return `${diffDays} day${diffDays === 1 ? '' : 's'} left`;
      } else if (diffDays === 0) {
        return 'Today!';
      } else {
        return `${Math.abs(diffDays)} day${Math.abs(diffDays) === 1 ? '' : 's'} ago`;
      }
    }

    // Load Events with hybrid positioning (time-based with fallback to even distribution)
    function loadEvents() {
      console.log("Loading events for user:", auth.currentUser?.email);
      
      const q = query(
        collection(db, "events"), 
        where("user", "==", auth.currentUser.email)
      );
      
      onSnapshot(q, (snapshot) => {
        console.log("Snapshot received, size:", snapshot.size);
        
        timelineDiv.innerHTML = "";
        document.getElementById("timelineYears").innerHTML = "";
        
        if (snapshot.empty) {
          console.log("No events found for user");
          timelineDiv.innerHTML = `
            <div class="empty-timeline">
              <div style="font-size: 4em; margin-bottom: 20px;">‚è∞</div>
              <h3>Your timeline is empty</h3>
              <p>Add your first personal event to get started!</p>
            </div>
          `;
          return;
        }

        // Convert to array and filter out very old events
        const events = [];
        const today = new Date();
        const cutoffDate = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000)); // 30 days ago
        
        snapshot.forEach(doc => {
          const eventData = doc.data();
          const eventDate = new Date(eventData.time);
          
          // Ensure we have a proper timestamp
          let timestamp = eventData.timestamp;
          if (!timestamp || isNaN(timestamp)) {
            timestamp = eventDate.getTime();
            console.log("Fixed timestamp for event:", doc.id, "from", eventData.timestamp, "to", timestamp);
          }
          
          console.log("Event found:", doc.id, {
            title: eventData.title,
            time: eventData.time,
            originalTimestamp: eventData.timestamp,
            fixedTimestamp: timestamp,
            eventDate: eventDate
          });
          
          // Remove events older than 30 days
          if (eventDate < cutoffDate) {
            console.log("Removing old event:", doc.id);
            deleteDoc(doc.ref).catch(err => console.error("Error deleting old event:", err));
          } else {
            events.push({ 
              id: doc.id, 
              ...eventData, 
              timestamp: timestamp // Use the fixed timestamp
            });
          }
        });
        
        // Sort events by timestamp
        events.sort((a, b) => a.timestamp - b.timestamp);
        console.log("Filtered and sorted events:", events);

        if (events.length === 0) {
          timelineDiv.innerHTML = `
            <div class="empty-timeline">
              <div style="font-size: 4em; margin-bottom: 20px;">‚è∞</div>
              <h3>Your timeline is empty</h3>
              <p>Add your first personal event to get started!</p>
            </div>
          `;
          return;
        }

        const containerWidth = timelineDiv.parentElement.clientWidth;
        
        // Always use even distribution for consistent spacing
        console.log("Using even distribution for all events");
        
        // Position today marker at the leftmost position
        const margin = 150;
        const left_1 =40;
        const todayPosition = left_1; // Always at the left margin
        
        console.log("Today position (leftmost):", todayPosition);
        
        // Add today marker at leftmost position
        const todayMarker = document.createElement('div');
        todayMarker.className = 'today-marker';
        todayMarker.style.left = todayPosition + 'px';
        timelineDiv.appendChild(todayMarker);

        // Create events with even distribution starting after today marker
        events.forEach((event, index) => {
          const eventDate = new Date(event.time);
          const isToday = today.toDateString() === eventDate.toDateString();
          
          console.log(`Event ${index}:`, event.title, "Timestamp:", event.timestamp, "Date:", eventDate, "Is today:", isToday);
          
          // Calculate position with today marker at leftmost
          const availableWidth = containerWidth - (2 * margin);
          let position;
          
          if (events.length === 1) {
            // If only one event, place it at a reasonable distance from today marker
            position = margin + (availableWidth * 0.3); // 30% from left
          } else {
            // Distribute events evenly across the remaining space
            const spacing = availableWidth / events.length;
            position = margin + ((index + 1) * spacing);
          }
          
          // Special handling for today events - they can overlap with today marker
          if (isToday) {
            position = todayPosition; // Place exactly on today marker
          }
          
          console.log(`Event ${index} position:`, position, "Is today:", isToday);
          
          // Alternate between above and below, with today events always above
          let isAbove;
          if (isToday) {
            isAbove = true; // Today events always go above and overlap today marker
          } else {
            isAbove = index % 2 === 0;
          }
          
          // Fixed connector height and spacing for consistency
          const connectorHeight = 70;
          const boxSpacing = 15;
          const totalDistance = connectorHeight + boxSpacing;
          
          const eventDiv = document.createElement('div');
          eventDiv.className = 'timeline-event';
          eventDiv.style.left = position + 'px';
          
          if (isAbove) {
            eventDiv.innerHTML = `
              <div class="event-marker ${isToday ? 'today' : ''}" onclick="openEditModal('${event.id}', '${event.title.replace(/'/g, "\\'")}', '${event.time}')"></div>
              <div class="event-connector above" style="height: ${connectorHeight}px;"></div>
              <div class="event-box above ${isToday ? 'today' : ''}" style="bottom: ${totalDistance}px;" onclick="openEditModal('${event.id}', '${event.title.replace(/'/g, "\\'")}', '${event.time}')">
                <div class="event-title">${event.title}</div>
                <div class="event-date">${formatDate(event.time)}</div>
                <div class="event-time-left">${getTimeUntilEvent(event.time)}</div>
                <div class="event-actions">
                  <button class="btn btn-small" onclick="event.stopPropagation(); openEditModal('${event.id}', '${event.title.replace(/'/g, "\\'")}', '${event.time}')">Edit</button>
                  <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteEvent('${event.id}')">Delete</button>
                </div>
              </div>
            `;
          } else {
            eventDiv.innerHTML = `
              <div class="event-marker ${isToday ? 'today' : ''}" onclick="openEditModal('${event.id}', '${event.title.replace(/'/g, "\\'")}', '${event.time}')"></div>
              <div class="event-connector below" style="height: ${connectorHeight}px;"></div>
              <div class="event-box below ${isToday ? 'today' : ''}" style="top: ${totalDistance}px;" onclick="openEditModal('${event.id}', '${event.title.replace(/'/g, "\\'")}', '${event.time}')">
                <div class="event-title">${event.title}</div>
                <div class="event-date">${formatDate(event.time)}</div>
                <div class="event-time-left">${getTimeUntilEvent(event.time)}</div>
                <div class="event-actions">
                  <button class="btn btn-small" onclick="event.stopPropagation(); openEditModal('${event.id}', '${event.title.replace(/'/g, "\\'")}', '${event.time}')">Edit</button>
                  <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteEvent('${event.id}')">Delete</button>
                </div>
              </div>
            `;
          }
          
          timelineDiv.appendChild(eventDiv);
        });

    // Get evenly distributed position based on chronological order (fallback method)
    function getEvenlyDistributedPosition(chronologicalIndex, totalEvents, containerWidth) {
      const margin = 150; // space on both sides
      const availableWidth = containerWidth - (2 * margin);

      if (totalEvents === 1) {
        return containerWidth / 2;
      }

      const spacing = availableWidth / (totalEvents - 1);
      return margin + (chronologicalIndex * spacing);
    }

        // Generate year markers based on time range
        const startYear = new Date(timeRange.startTime).getFullYear();
        const endYear = new Date(timeRange.endTime).getFullYear();
        const yearsDiv = document.getElementById("timelineYears");
        
        for (let year = startYear; year <= endYear; year++) {
          const yearDiv = document.createElement('div');
          yearDiv.textContent = year;
          
          // Position year marker based on January 1st of that year
          const yearStart = new Date(year, 0, 1).getTime();
          const yearPosition = getTimeBasedPosition(yearStart, timeRange, containerWidth);
          yearDiv.style.position = 'absolute';
          yearDiv.style.left = yearPosition + 'px';
          
          yearsDiv.appendChild(yearDiv);
        }
      }, (error) => {
        console.error("Error loading events:", error);
        timelineDiv.innerHTML = `
          <div class="empty-timeline">
            <div style="font-size: 4em; margin-bottom: 20px;">‚ö†</div>
            <h3>Error loading events</h3>
            <p>${error.message}</p>
          </div>
        `;
      });
    }

    // Format date for display
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Make functions global for onclick handlers
    window.openEditModal = openEditModal;
    window.deleteEvent = deleteEvent;

    // Handle window resize
    window.addEventListener('resize', () => {
      if (auth.currentUser) {
        loadEvents();
      }
    });
  </script>
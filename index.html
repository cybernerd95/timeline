<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Timeline</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .auth-section {
      padding: 40px;
      text-align: center;
    }

    .auth-form {
      max-width: 400px;
      margin: 0 auto;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }

    input[type="email"],
    input[type="password"],
    input[type="datetime-local"],
    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
      transition: transform 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
    }

    .error {
      color: #e74c3c;
      margin-top: 10px;
      padding: 10px;
      background: #ffeaea;
      border-radius: 5px;
    }

    .timeline-section {
      padding: 40px;
      display: none;
    }

    .timeline-controls {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 40px;
    }

    .timeline-controls h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .timeline-container {
      position: relative;
      padding: 40px 0;
      overflow-x: auto;
    }

    .timeline-line {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(to right, #667eea, #764ba2, #667eea);
      border-radius: 2px;
      transform: translateY(-50%);
    }

    .timeline-events {
      display: flex;
      position: relative;
      min-height: 200px;
      align-items: center;
      gap: 100px;
      padding: 0 50px;
    }

    .timeline-event {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 200px;
      z-index: 2;
    }

    .event-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: white;
      border: 4px solid #667eea;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      z-index: 3;
    }

    .event-dot::before {
      content: '';
      position: absolute;
      top: -2px;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 0;
      background: linear-gradient(to top, #667eea, #764ba2);
      transition: height 0.6s ease-out;
      z-index: 1;
    }

    .event-dot.animate::before {
      height: 60px;
    }

    .event-dot.animate-below::before {
      top: 100%;
      height: 0;
      transition: height 0.6s ease-out;
    }

    .event-dot.animate-below.animate::before {
      height: 60px;
    }

    .event-dot.today {
      background: #ff6b6b;
      border-color: #ff6b6b;
      box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.5); }
      50% { box-shadow: 0 0 30px rgba(255, 107, 107, 0.8); }
      100% { box-shadow: 0 0 20px rgba(255, 107, 107, 0.5); }
    }

    .event-content {
      position: absolute;
      top: -80px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      border: 2px solid #667eea;
      min-width: 180px;
      text-align: center;
      transform: translateX(-50%) translateY(20px);
      left: 50%;
      opacity: 0;
      transition: all 0.4s ease-out;
      transition-delay: 0.6s;
    }

    .event-content.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .event-content.below {
      top: 40px;
      transform: translateX(-50%) translateY(-20px);
    }

    .event-content.below.show {
      transform: translateX(-50%) translateY(0);
    }

    .event-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
      font-size: 0.9em;
    }

    .event-date {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 8px;
    }

    .event-time-left {
      font-size: 0.7em;
      color: #999;
      margin-bottom: 8px;
      font-style: italic;
    }

    .event-actions {
      display: flex;
      gap: 4px;
      justify-content: center;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
    }

    .today-marker {
      position: absolute;
      top: 50%;
      left: 200px;
      width: 3px;
      height: 60px;
      background: #ff6b6b;
      transform: translateY(-50%);
      z-index: 4;
      box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
    }

    .today-marker::before {
      content: 'TODAY';
      position: absolute;
      bottom: 62px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff6b6b;
      color: white;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
    }

    .close {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .close:hover {
      color: #333;
    }

    .empty-timeline {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-timeline i {
      font-size: 4em;
      margin-bottom: 20px;
      color: #ccc;
    }

    .logout-container {
      text-align: right;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .timeline-events {
        flex-direction: column;
        gap: 60px;
        padding: 20px;
      }

      .timeline-line {
        top: 0;
        bottom: 0;
        left: 50%;
        right: auto;
        width: 4px;
        height: auto;
        transform: translateX(-50%);
        background: linear-gradient(to bottom, #667eea, #764ba2, #667eea);
      }

      .event-content {
        position: relative;
        top: 20px;
        left: 0;
        transform: none;
        margin-left: 30px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìÖ Interactive Timeline</h1>
      <p>Create and manage your events timeline</p>
    </div>

    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
      <div class="auth-form">
        <h2>Login to Your Timeline</h2>
        <div class="form-group">
          <label for="email">Email:</label>
          <input type="email" id="email" placeholder="Enter your email">
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input type="password" id="password" placeholder="Enter your password">
        </div>
        <button id="loginBtn" class="btn">Login</button>
        <button id="registerBtn" class="btn btn-secondary">Register</button>
        <div id="authError" class="error" style="display: none;"></div>
      </div>
    </div>

    <!-- Timeline Section -->
    <div id="timelineSection" class="timeline-section">
      <div class="logout-container">
        <span id="userEmail" style="margin-right: 15px; color: #666; font-weight: 500;"></span>
        <button id="logoutBtn" class="btn btn-danger">Logout</button>
      </div>

      <div class="timeline-controls">
        <h3>Add New Event</h3>
        <form id="eventForm">
          <div style="display: flex; gap: 15px; align-items: end; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="title">Event Title:</label>
              <input type="text" id="title" placeholder="Enter event title" required>
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
              <label for="time">Date & Time:</label>
              <input type="datetime-local" id="time" required>
            </div>
            <button type="submit" class="btn">Add Event</button>
          </div>
        </form>
      </div>

      <div class="timeline-container">
        <div class="timeline-line"></div>
        <div id="timeline" class="timeline-events">
          <div class="empty-timeline">
            <div style="font-size: 4em; margin-bottom: 20px;">‚è∞</div>
            <h3>No events yet</h3>
            <p>Add your first event to get started!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Edit Event</h3>
      <form id="editForm">
        <div class="form-group">
          <label for="editTitle">Event Title:</label>
          <input type="text" id="editTitle" required>
        </div>
        <div class="form-group">
          <label for="editTime">Date & Time:</label>
          <input type="datetime-local" id="editTime" required>
        </div>
        <div style="text-align: center; margin-top: 20px;">
          <button type="submit" class="btn">Save Changes</button>
          <button type="button" id="cancelEdit" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    // Firebase configuration (replace with your config)
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, doc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Replace with your Firebase config
    const firebaseConfig = {
      // Your Firebase configuration
      apiKey: "AIzaSyAkWss4GTWopwjrqAEe71PUhiWHdGKTMlw",
      authDomain: "tasktimeline-4dffe.firebaseapp.com",
      projectId: "tasktimeline-4dffe",
      storageBucket: "tasktimeline-4dffe.firebasestorage.app",
      messagingSenderId: "329516169618",
      appId: "1:329516169618:web:e1fdd96fccab750f68294b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM elements
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const authError = document.getElementById("authError");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const authSection = document.getElementById("authSection");
    const timelineSection = document.getElementById("timelineSection");
    const eventForm = document.getElementById("eventForm");
    const timeInput = document.getElementById("time");
    const titleInput = document.getElementById("title");
    const timelineDiv = document.getElementById("timeline");
    const editModal = document.getElementById("editModal");
    const editForm = document.getElementById("editForm");
    const editTitle = document.getElementById("editTitle");
    const editTime = document.getElementById("editTime");

    let currentEditId = null;

    // Register
    registerBtn.addEventListener("click", () => {
      console.log("Attempting to register:", emailInput.value);
      createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
        .then(userCredential => {
          console.log("Registration successful:", userCredential.user.email);
          authError.style.display = 'none';
        })
        .catch(err => {
          console.error("Registration error:", err);
          authError.textContent = err.message;
          authError.style.display = 'block';
        });
    });

    // Login
    loginBtn.addEventListener("click", () => {
      console.log("Attempting to login:", emailInput.value);
      signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value)
        .then(userCredential => {
          console.log("Login successful:", userCredential.user.email);
          authError.style.display = 'none';
        })
        .catch(err => {
          console.error("Login error:", err);
          authError.textContent = err.message;
          authError.style.display = 'block';
        });
    });

    // Logout
    logoutBtn.addEventListener("click", () => signOut(auth));

    // Auth State
    onAuthStateChanged(auth, user => {
      if(user){
        authSection.style.display = "none";
        timelineSection.style.display = "block";
        document.getElementById("userEmail").textContent = `Welcome, ${user.email}`;
        loadEvents();
      } else {
        authSection.style.display = "block";
        timelineSection.style.display = "none";
        timelineDiv.innerHTML = "";
      }
    });

    // Add Event
    eventForm.addEventListener("submit", async e => {
      e.preventDefault();
      console.log("Attempting to add event...");
      console.log("User:", auth.currentUser?.email);
      console.log("Title:", titleInput.value);
      console.log("Time:", timeInput.value);
      
      try {
        const docRef = await addDoc(collection(db, "events"), {
          time: timeInput.value,
          title: titleInput.value,
          user: auth.currentUser.email,
          timestamp: new Date(timeInput.value).getTime(),
          createdAt: new Date()
        });
        console.log("Event added with ID: ", docRef.id);
        eventForm.reset();
      } catch (err) {
        console.error("Error adding event:", err);
        alert("Error adding event: " + err.message);
      }
    });

    // Edit Event
    editForm.addEventListener("submit", async e => {
      e.preventDefault();
      if (currentEditId) {
        try {
          await updateDoc(doc(db, "events", currentEditId), {
            title: editTitle.value,
            time: editTime.value,
            timestamp: new Date(editTime.value).getTime()
          });
          editModal.style.display = "none";
          currentEditId = null;
        } catch (err) {
          console.error("Error updating event:", err);
        }
      }
    });

    // Delete Event
    async function deleteEvent(id) {
      if (confirm("Are you sure you want to delete this event?")) {
        try {
          await deleteDoc(doc(db, "events", id));
        } catch (err) {
          console.error("Error deleting event:", err);
        }
      }
    }

    // Open Edit Modal
    function openEditModal(id, title, time) {
      currentEditId = id;
      editTitle.value = title;
      editTime.value = time;
      editModal.style.display = "block";
    }

    // Close Modal
    document.querySelector(".close").addEventListener("click", () => {
      editModal.style.display = "none";
    });

    document.getElementById("cancelEdit").addEventListener("click", () => {
      editModal.style.display = "none";
    });

    window.addEventListener("click", (e) => {
      if (e.target === editModal) {
        editModal.style.display = "none";
      }
    });

    // Calculate position based on date difference from today
    function getEventPosition(eventDate) {
      const today = new Date();
      const event = new Date(eventDate);
      const daysDiff = Math.floor((event - today) / (1000 * 60 * 60 * 24));
      
      // Today is at position 200px, each day is 80px apart
      return 200 + (daysDiff * 80);
    }

    // Generate random distance for event boxes (30px to 80px from timeline)
    function getRandomDistance() {
      return Math.floor(Math.random() * (80 - 30 + 1)) + 30;
    }

    // Calculate time until/since event
    function getTimeUntilEvent(eventDate) {
      const now = new Date();
      const event = new Date(eventDate);
      const diffMs = event - now;
      const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffDays > 0) {
        return `${diffDays} day${diffDays === 1 ? '' : 's'} left`;
      } else if (diffDays === 0) {
        return 'Today!';
      } else {
        return `${Math.abs(diffDays)} day${Math.abs(diffDays) === 1 ? '' : 's'} ago`;
      }
    }

    // Auto-scroll timeline to show today
    function scrollToToday() {
      const timelineContainer = document.querySelector('.timeline-container');
      timelineContainer.scrollLeft = Math.max(0, 200 - timelineContainer.clientWidth / 2);
    }

    // Load Events - Filter by current user and remove old events
    function loadEvents() {
      console.log("Loading events for user:", auth.currentUser?.email);
      
      const q = query(
        collection(db, "events"), 
        where("user", "==", auth.currentUser.email)
      );
      
      onSnapshot(q, (snapshot) => {
        console.log("Snapshot received, size:", snapshot.size);
        
        timelineDiv.innerHTML = "";
        
        // Add today marker
        const todayMarker = document.createElement('div');
        todayMarker.className = 'today-marker';
        timelineDiv.appendChild(todayMarker);
        
        if (snapshot.empty) {
          console.log("No events found for user");
          timelineDiv.innerHTML += `
            <div class="empty-timeline" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
              <div style="font-size: 4em; margin-bottom: 20px;">‚è∞</div>
              <h3>Your timeline is empty</h3>
              <p>Add your first personal event to get started!</p>
              <small style="color: #999; margin-top: 10px; display: block;">
                Debug: User ${auth.currentUser.email}
              </small>
            </div>
          `;
          return;
        }

        // Convert to array and filter out old events
        const events = [];
        const today = new Date();
        const cutoffDate = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000)); // 7 days ago
        
        snapshot.forEach(doc => {
          const eventData = doc.data();
          const eventDate = new Date(eventData.time);
          
          console.log("Event found:", doc.id, eventData);
          
          // Remove events older than 7 days
          if (eventDate < cutoffDate) {
            console.log("Removing old event:", doc.id);
            deleteDoc(doc.ref).catch(err => console.error("Error deleting old event:", err));
          } else {
            events.push({ id: doc.id, ...eventData });
          }
        });
        
        events.sort((a, b) => a.timestamp - b.timestamp);
        console.log("Filtered and sorted events:", events);

        let eventIndex = 0;
        events.forEach(ev => {
          const isAbove = eventIndex % 2 === 0;
          const eventDate = new Date(ev.time);
          const isToday = today.toDateString() === eventDate.toDateString();
          const position = getEventPosition(ev.time);
          const randomDistance = getRandomDistance();
          
          const eventDiv = document.createElement('div');
          eventDiv.className = 'timeline-event';
          eventDiv.style.left = position + 'px';
          
          // Create connector and content elements with random distances
          const connectorHeight = randomDistance;
          const contentPosition = randomDistance + 10; // 10px gap between line and box
          
          eventDiv.innerHTML = `
            <div class="event-dot ${isToday ? 'today' : ''}" onclick="openEditModal('${ev.id}', '${ev.title}', '${ev.time}')"></div>
            <div class="event-connector ${isAbove ? 'above' : 'below'}" style="height: ${connectorHeight}px;"></div>
            <div class="event-content ${isAbove ? 'above' : 'below'} ${isToday ? 'today-event' : ''}" style="${isAbove ? 'bottom' : 'top'}: ${contentPosition}px;">
              <div class="event-title">${ev.title}</div>
              <div class="event-date">${formatDate(ev.time)}</div>
              <div class="event-time-left">${getTimeUntilEvent(ev.time)}</div>
              <div class="event-actions">
                <button class="btn btn-small" onclick="openEditModal('${ev.id}', '${ev.title}', '${ev.time}')">Edit</button>
                <button class="btn btn-small btn-danger" onclick="deleteEvent('${ev.id}')">Delete</button>
              </div>
            </div>
          `;
          
          timelineDiv.appendChild(eventDiv);
          eventIndex++;
        });
        
        // Auto-scroll to show today
        setTimeout(scrollToToday, 100);
      }, (error) => {
        console.error("Error loading events:", error);
        timelineDiv.innerHTML = `
          <div class="empty-timeline" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);">
            <div style="font-size: 4em; margin-bottom: 20px;">‚ùå</div>
            <h3>Error loading events</h3>
            <p>${error.message}</p>
          </div>
        `;
      });
    }

    // Format date for display
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString() + " " + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Check if date is today
    function isToday(dateString) {
      const today = new Date();
      const eventDate = new Date(dateString);
      return today.toDateString() === eventDate.toDateString();
    }

    // Make functions global for onclick handlers
    window.openEditModal = openEditModal;
    window.deleteEvent = deleteEvent;
  </script>
</body>
</html>